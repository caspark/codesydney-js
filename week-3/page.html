<html>
    <head>
        <title>Awesome page</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script>
            // game parameters
            var game = (function() {
                // config
                var width =  40,
                    height = 40,
                    initialLen = 2,
                // --- state which needs to be reset ---
                // an index in an array for each segment of the snake shows the segment position
                    segments,
                // speed controls direction as well; 1 = right, -width = up, etc
                    speed,
                // position of the apple
                    apple

                var calculateNewApplePos = function(snakeSegments) {
                    var candidate
                    do {
                        candidate = Math.floor(Math.random() * width * height)
                    } while (snakeSegments.indexOf(candidate) != -1)
                    return candidate
                }


                return {
                    reset: function() {
                        segments = []
                        segments.push(width * (height / 2 + 0.5))
                        for (var i = 1; i < initialLen; i++) {
                            segments[i] = segments[i - 1] - 1
                        }
                        speed = 0
                        apple = calculateNewApplePos(segments)
                    },

                    render: function() {
                        var boardDiv = $('#board').detach().empty(),
                            type
                        for (var i = 0; i < width * height; i++) {
                            if (i === apple) {
                                type = "apple"
                            } else if (i === segments[0]) {
                                type = "snake-head"
                            } else if (segments.indexOf(i) !== -1) {
                                type = "snake"
                            } else {
                                type = "nothing"
                            }
                            var div = $('<div>')
                            if (type) {
                                div.addClass(type)
                            }
                            boardDiv.append(div)
                        }
                        $('body').append(boardDiv)
                    },

                    update: function() {
                        if (speed != 0) {
                            var nextPos = segments[0] + speed
                            if (nextPos < 0
                                    || nextPos > width * height
                                    || Math.floor(segments[0] / 40) != Math.floor(nextPos / 40) && Math.abs(speed) === 1) {
                                console.debug("Snake went off the screen")
                                this.reset()
                            } else {
                                segments.unshift(nextPos)
                                if (segments[segments.length - 1] == apple) {
                                    console.debug("Snake finished digesting apple")
                                    apple = calculateNewApplePos(segments)
                                } else {
                                    segments.pop()
                                }
                                console.debug("Snake is now at", segments)
                            }

                            for (var i = 0; i < segments.length - 1; i++) {
                                for (var j = i + 1; j < segments.length; j++) {
                                    if (segments[i] === segments[j]) {
                                        console.debug('Snake collided with self!')
                                        this.reset()
                                    }
                                }
                            }
                        }
                    },

                    handleInput: function(input) {
                        if (input === 'up') {
                            speed = -width
                        } else if (input === 'down') {
                            speed = width
                        } else if (input === 'left') {
                            speed = -1
                        } else if (input === 'right') {
                            speed = 1
                        } else if (input === 'pause') {
                            speed = 0
                        }
                        console.debug('speed is now', speed)
                    }
                }
            })()

            $(function() {
                $('body').on('keydown', function(e) {
                    if (e.which === 87) { // W
                        game.handleInput('up')
                    } else if (e.which === 83) { // S
                        game.handleInput('down')
                    } else if (e.which === 65) { // A
                        game.handleInput('left')
                    } else if (e.which === 68) { // D
                        game.handleInput('right')
                    } else if (e.which === 32 || e.which === 27) { // Space & Esc
                        game.handleInput('pause')
                    } else {
                        console.debug('Unrecognised key pressed: ' + e.which)
                    }
                })

                game.reset()
                requestAnimationFrame(function tick() {
                    game.update()
                    game.render()
                    requestAnimationFrame(tick)
                })
            })
        </script>
        <style>
            #board div {
                display: inline-block;
                height: 2.5%;
                overflow: none;
                width: 2.5%;
            }

            .apple {
                background-color: green;
            }

            .snake-head {
                background-color: pink;
            }

            .snake {
                background-color: red;
            }

            .nothing {
                border: 1px dotted grey;
                margin: -1px;
            }
        </style>
    </head>
    <body>
        <div id="board"></div>
    </body>
</html>
